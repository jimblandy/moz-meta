#!/usr/bin/env bash

set -eux

# We'd like to run everything with our MSRV, 1.43, but `cargo fmt`, `cargo
# clippy`, and `cargo doc` from that toolchain are all missing features we use
# now. So the only thing we use the MSRV for is `cargo check`.

# The validation step needs to run `make`.
if ! [ -f Makefile ]; then
    echo "Run in top directory of package." >&2
    exit 1
fi

cargo fmt
#cargo clippy --all-features --workspace -- -D warnings

cargo test --all-features --workspace
# disable on akatsuki: dot
make validate-wgsl validate-spv validate-glsl

set +x # this affects $(...) capture, apparently
if ! output=$(make validate-hlsl-dxc 2>&1); then
    echo "$output" >&2
    echo "HLSL validation failed" >&2
    exit 1
fi
set -x

# The no-features case.
cargo test -p naga

# Make sure all documentation builds.
RUSTDOCFLAGS='-Dwarnings' cargo doc -p naga --all-features --no-deps --document-private-items

# Check MSRV compatibility.
# Newer Rust versions don't like reading the metadata
# cargo +1.43 check --all-features
